# ğŸ‘Œå¦‚ä½•é…ç½®æœåŠ¡ç†”æ–­

<font style="background-color:rgb(247, 248, 249);">é…ç½®æœåŠ¡ç†”æ–­æ¶‰åŠå®šä¹‰ç†”æ–­å™¨çš„è¡Œä¸ºå’Œå‚æ•°ï¼Œä»¥ä¾¿åœ¨æ£€æµ‹åˆ°æœåŠ¡æ•…éšœæˆ–å“åº”æ—¶é—´è¿‡é•¿æ—¶è§¦å‘ç†”æ–­ã€‚</font>

### <font style="background-color:rgb(247, 248, 249);">ä½¿ç”¨ Hystrix é…ç½®æœåŠ¡ç†”æ–­</font>
<font style="background-color:rgb(247, 248, 249);">Hystrix æ˜¯ Netflix å¼€å‘çš„ä¸€ä¸ªåº“ï¼Œå°½ç®¡å…¶ç»´æŠ¤å·²åœæ­¢ï¼Œä½†å®ƒçš„ä½¿ç”¨æ–¹æ³•ä»ç„¶å…·æœ‰å‚è€ƒä»·å€¼ã€‚</font>

1. **<font style="background-color:rgb(247, 248, 249);">æ·»åŠ ä¾èµ–</font>**<font style="background-color:rgb(247, 248, 249);">ï¼š  
</font><font style="background-color:rgb(247, 248, 249);">ç¡®ä¿åœ¨é¡¹ç›®çš„</font><font style="background-color:rgb(247, 248, 249);"> </font>`<font style="background-color:rgb(247, 248, 249);">pom.xml</font>`<font style="background-color:rgb(247, 248, 249);"> </font><font style="background-color:rgb(247, 248, 249);">æ–‡ä»¶ä¸­æ·»åŠ  Hystrix ä¾èµ–ï¼š</font>

```plain
<dependency>
    <groupId>com.netflix.hystrix</groupId>
    <artifactId>hystrix-core</artifactId>
    <version>1.5.18</version>
</dependency>
```

2. **<font style="background-color:rgb(247, 248, 249);">å®šä¹‰ Hystrix å‘½ä»¤</font>**<font style="background-color:rgb(247, 248, 249);">ï¼š  
</font><font style="background-color:rgb(247, 248, 249);">åˆ›å»ºä¸€ä¸ªç»§æ‰¿</font><font style="background-color:rgb(247, 248, 249);"> </font>`<font style="background-color:rgb(247, 248, 249);">HystrixCommand</font>`<font style="background-color:rgb(247, 248, 249);"> </font><font style="background-color:rgb(247, 248, 249);">çš„ç±»ï¼Œå¹¶é…ç½®ç†”æ–­å™¨å‚æ•°ã€‚</font>

```plain
import com.netflix.hystrix.HystrixCommand;
import com.netflix.hystrix.HystrixCommandGroupKey;
import com.netflix.hystrix.HystrixCommandProperties;

public class MyServiceCommand extends HystrixCommand<String> {

    private final String name;

    public MyServiceCommand(String name) {
        super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey("ExampleGroup"))
                .andCommandPropertiesDefaults(HystrixCommandProperties.Setter()
                        .withCircuitBreakerRequestVolumeThreshold(10) // è¯·æ±‚æ•°è¾¾åˆ°10æ¬¡æ‰è®¡ç®—å¤±è´¥ç‡
                        .withCircuitBreakerSleepWindowInMilliseconds(5000) // ç†”æ–­å™¨æ‰“å¼€åï¼Œç­‰å¾…5ç§’å†å°è¯•æ¢å¤
                        .withCircuitBreakerErrorThresholdPercentage(50))); // å¤±è´¥ç‡è¾¾åˆ°50%æ—¶ï¼Œç†”æ–­å™¨æ‰“å¼€
        this.name = name;
    }

    @Override
    protected String run() {
        // æ¨¡æ‹Ÿè¿œç¨‹æœåŠ¡è°ƒç”¨
        if (name.equals("fail")) {
            throw new RuntimeException("Service failure");
        }
        return "Hello, " + name;
    }

    @Override
    protected String getFallback() {
        return "Hello, fallback";
    }

    public static void main(String[] args) {
        for (int i = 0; i < 15; i++) {
            MyServiceCommand command = new MyServiceCommand(i < 5 ? "World" : "fail");
            System.out.println(command.execute()); // å‰5æ¬¡æˆåŠŸï¼Œå10æ¬¡å¤±è´¥
        }
    }
}
```

### <font style="background-color:rgb(247, 248, 249);">ä½¿ç”¨ Resilience4j é…ç½®æœåŠ¡ç†”æ–­</font>
<font style="background-color:rgb(247, 248, 249);">Resilience4j æ˜¯ä¸€ä¸ªæ›´ç°ä»£çš„åº“ï¼Œæ¨èç”¨äºæ›¿ä»£ Hystrixã€‚</font>

1. **<font style="background-color:rgb(247, 248, 249);">æ·»åŠ ä¾èµ–</font>**<font style="background-color:rgb(247, 248, 249);">ï¼š  
</font><font style="background-color:rgb(247, 248, 249);">åœ¨</font><font style="background-color:rgb(247, 248, 249);"> </font>`<font style="background-color:rgb(247, 248, 249);">pom.xml</font>`<font style="background-color:rgb(247, 248, 249);"> </font><font style="background-color:rgb(247, 248, 249);">æ–‡ä»¶ä¸­æ·»åŠ  Resilience4j ä¾èµ–ï¼š</font>

```plain
<dependency>
    <groupId>io.github.resilience4j</groupId>
    <artifactId>resilience4j-spring-boot2</artifactId>
    <version>1.7.0</version>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-aop</artifactId>
</dependency>
```

2. **<font style="background-color:rgb(247, 248, 249);">é…ç½®ç†”æ–­å™¨</font>**<font style="background-color:rgb(247, 248, 249);">ï¼š  
</font><font style="background-color:rgb(247, 248, 249);">åœ¨</font><font style="background-color:rgb(247, 248, 249);"> </font>`<font style="background-color:rgb(247, 248, 249);">application.yml</font>`<font style="background-color:rgb(247, 248, 249);"> </font><font style="background-color:rgb(247, 248, 249);">æ–‡ä»¶ä¸­é…ç½®ç†”æ–­å™¨å‚æ•°ï¼š</font>

```plain
resilience4j.circuitbreaker:
  instances:
    myService:
      registerHealthIndicator: true
      slidingWindowSize: 10
      failureRateThreshold: 50
      waitDurationInOpenState: 5s
      permittedNumberOfCallsInHalfOpenState: 3
      slidingWindowType: COUNT_BASED
      minimumNumberOfCalls: 10
      automaticTransitionFromOpenToHalfOpenEnabled: true
```

3. **<font style="background-color:rgb(247, 248, 249);">ä½¿ç”¨ç†”æ–­å™¨</font>**<font style="background-color:rgb(247, 248, 249);">ï¼š  
</font><font style="background-color:rgb(247, 248, 249);">åœ¨æœåŠ¡ç±»ä¸­ä½¿ç”¨</font><font style="background-color:rgb(247, 248, 249);"> </font>`<font style="background-color:rgb(247, 248, 249);">@CircuitBreaker</font>`<font style="background-color:rgb(247, 248, 249);"> </font><font style="background-color:rgb(247, 248, 249);">æ³¨è§£ã€‚</font>

```plain
import io.github.resilience4j.circuitbreaker.annotation.CircuitBreaker;
import org.springframework.stereotype.Service;

@Service
public class MyService {

    @CircuitBreaker(name = "myService", fallbackMethod = "fallback")
    public String callService(String name) {
        if ("fail".equals(name)) {
            throw new RuntimeException("Service failure");
        }
        return "Hello, " + name;
    }

    public String fallback(String name, Throwable throwable) {
        return "Hello, fallback";
    }
}
```

4. **<font style="background-color:rgb(247, 248, 249);">æµ‹è¯•ç†”æ–­å™¨</font>**<font style="background-color:rgb(247, 248, 249);">ï¼š  
</font><font style="background-color:rgb(247, 248, 249);">ä½¿ç”¨ Spring Boot æµ‹è¯•æ¡†æ¶æµ‹è¯•ç†”æ–­å™¨çš„è¡Œä¸ºã€‚</font>

```plain
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;

@Component
public class TestRunner implements CommandLineRunner {

    @Autowired
    private MyService myService;

    @Override
    public void run(String... args) throws Exception {
        for (int i = 0; i < 15; i++) {
            try {
                System.out.println(myService.callService(i < 5 ? "World" : "fail"));
            } catch (Exception e) {
                System.out.println(e.getMessage());
            }
        }
    }
}
```

### <font style="background-color:rgb(247, 248, 249);">æ€»ç»“</font>
<font style="background-color:rgb(247, 248, 249);">æœåŠ¡ç†”æ–­æ˜¯ä¸€ç§é‡è¦çš„ä¿æŠ¤æœºåˆ¶ï¼Œå¯ä»¥é˜²æ­¢åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ•…éšœè”“å»¶ã€‚é€šè¿‡é…ç½® Hystrix æˆ– Resilience4jï¼Œå¯ä»¥å®ç°æœåŠ¡ç†”æ–­ï¼Œå¹¶åœ¨æœåŠ¡å‡ºç°æ•…éšœæ—¶æä¾›å›é€€æœºåˆ¶ï¼Œç¡®ä¿ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚å°½ç®¡ Hystrix å·²åœæ­¢ç»´æŠ¤ï¼Œä½†å…¶è®¾è®¡ç†å¿µä»ç„¶å…·æœ‰å‚è€ƒä»·å€¼ï¼Œè€Œ Resilience4j æ˜¯ä¸€ä¸ªæ›´ç°ä»£ä¸”æ¨èä½¿ç”¨çš„æ›¿ä»£æ–¹æ¡ˆã€‚</font>



> åŸæ–‡: <https://www.yuque.com/jingdianjichi/xyxdsi/tkoytc5yue51rrcb>
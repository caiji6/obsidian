# 👌TCP两次握手不可以吗？

三次握手的设计是为了确保双方都能正确地接收和发送数据，并且可以处理网络中的各种不可靠因素。如果只使用两次握手，可能会导致一些问题。

### 三次握手的过程
1. **第一次握手（SYN）**：
    - 客户端发送一个SYN（同步序列号）包给服务器，请求建立连接。
    - 客户端进入SYN_SENT状态。
2. **第二次握手（SYN-ACK）**：
    - 服务器收到SYN包后，发送一个SYN-ACK包给客户端，表示同意建立连接，并确认客户端的SYN包。
    - 服务器进入SYN_RECEIVED状态。
3. **第三次握手（ACK）**：
    - 客户端收到SYN-ACK包后，发送一个ACK包给服务器，确认服务器的SYN-ACK包。
    - 客户端和服务器都进入ESTABLISHED状态，连接建立完成。

### 两次握手的问题
如果只使用两次握手，可能会导致以下问题：

1. **旧的重复连接请求**：
    - 假设一个旧的SYN包在网络中延迟了很长时间，最终到达服务器。服务器会认为这是一个新的连接请求并发送SYN-ACK包。
    - 如果没有第三次握手，服务器会认为连接已经建立，但客户端可能根本没有发起这个连接请求，导致服务器资源被浪费。
2. **确认数据传输的可靠性**：
    - 三次握手确保双方都能接收和发送数据。第一次握手确认客户端能发送，第二次握手确认服务器能接收并发送，第三次握手确认客户端能接收。
    - 两次握手无法确认客户端是否能正确接收服务器的数据，可能导致数据传输的不可靠。

### 具体情景
#### 场景一：旧SYN包的影响
+ 客户端A向服务器B发送一个SYN包请求建立连接，但由于网络问题这个包延迟了。
+ 客户端A超时重传了一个新的SYN包，并完成了三次握手，建立了一个新的连接。
+ 旧的SYN包在网络中继续传输，最终到达服务器B。
+ 服务器B认为这是一个新的连接请求，发送SYN-ACK包。
+ 如果没有第三次握手，服务器B会认为连接已经建立，但客户端A并没有对此做出响应。

#### 场景二：数据传输确认
+ 客户端A发送SYN包，服务器B发送SYN-ACK包。
+ 如果客户端A没有发送ACK包，服务器B无法确认客户端A是否收到了SYN-ACK包。
+ 这可能导致服务器B发送的数据包无法被客户端A正确接收。

## 为什么tcp连接是3次，关闭是4次？
**数据传输的完整性**：关闭连接时，需要确保所有数据都已传输完毕，因此需要额外的确认步骤。

**半关闭状态**：TCP允许连接的一方在发送完数据后立即关闭发送通道，但仍然可以接收数据。这种半关闭状态需要额外的步骤来确认。

**TIME_WAIT状态**：为了确保对方收到最后的ACK包，并防止旧的重复数据包干扰新的连接，发送最后一个ACK的一方进入TIME_WAIT状态。



> 原文: <https://www.yuque.com/jingdianjichi/xyxdsi/yny5p5knsg6nbogn>
# 👌客户端在和集群连接时，如何选择特定的节点执行请求的？

### 1. 节点发现
当客户端（如 Elasticsearch Java 客户端、HTTP 客户端等）启动时，它会尝试连接到一个或多个初始节点（通常通过配置提供）。这些初始节点作为引导节点，帮助客户端发现集群中的其他节点。

+ **初始节点列表**：客户端在配置时通常会提供一个初始节点列表，包含集群中一个或多个节点的地址。
+ **节点发现**：客户端连接到初始节点后，会请求集群状态信息，获取集群中所有节点的列表。

### 2. 节点选择策略
在获得集群中所有节点的信息后，客户端会根据特定的策略选择一个节点来执行请求。常见的节点选择策略包括：

#### a. 轮询（Round Robin）
客户端通常使用轮询策略来选择节点，即每次请求依次选择不同的节点。这种策略能够均衡负载，避免某个节点过载。

+ **示例**：假设集群中有节点 A、B 和 C。客户端第一次请求选择节点 A，第二次请求选择节点 B，第三次请求选择节点 C，依此类推。

#### b. 随机选择（Random Selection）
客户端可以随机选择一个节点来执行请求。这种策略也能够均衡负载，但可能会有一定的随机性。

+ **示例**：客户端每次请求随机选择节点 A、B 或 C 之一。

#### c. 自定义策略
在某些情况下，客户端可以实现自定义的节点选择策略，例如基于节点的负载、地理位置、网络延迟等因素。

+ **示例**：客户端可以选择距离最近的节点，或者选择当前负载最低的节点。

### 3. 节点角色和请求类型
根据请求的类型和节点的角色，客户端可能会选择特定类型的节点来执行请求。Elasticsearch 节点有不同的角色，如 Master 节点、数据节点、协调节点等。

+ **读请求（Search/Get）**：读请求通常可以发送到任何数据节点。客户端会根据节点选择策略选择一个数据节点来处理请求。
+ **写请求（Index/Update/Delete）**：写请求通常也可以发送到任何数据节点。客户端会选择一个数据节点来处理写请求，数据节点会负责将请求转发到正确的分片。
+ **集群管理请求**：集群管理请求（如创建索引、更新集群设置等）通常需要发送到 Master 节点。客户端会选择当前的 Master 节点来处理这些请求。

### 4. 故障处理和重试机制
为了提高可靠性，客户端通常会实现故障处理和重试机制。当选择的节点不可用时，客户端会尝试连接其他节点。

+ **故障检测**：客户端会检测节点的可用性。如果节点不可用（如连接失败），客户端会将其标记为不可用。
+ **重试机制**：当请求失败时，客户端会尝试重试请求，选择另一个可用节点来执行请求。



> 原文: <https://www.yuque.com/jingdianjichi/xyxdsi/okvoiuslgnkb9awz>
# 👌Elasticsearch是如何实现Master选举的？

Elasticsearch 使用一种基于分布式共识算法的机制来实现 Master 节点的选举。具体来说，Elasticsearch 使用了一个称为 Zen Discovery 的模块，该模块实现了一个类似于 Raft 或 Paxos 的算法来确保在集群中有且只有一个 Master 节点。

### 1. 节点启动
当一个 Elasticsearch 节点启动时，它会尝试加入一个现有的集群或创建一个新的集群。如果它加入一个现有集群，它会向集群中的其他节点发送加入请求。

### 2. 发现其他节点
节点通过多播（在非生产环境中）或单播（在生产环境中）发现其他节点。发现的节点信息会被记录下来，形成一个候选节点列表。

### 3. 节点状态
每个节点都有一个状态，主要包括以下几种：

+ **Master-Eligible**：有资格成为 Master 节点的节点。
+ **Non-Master-Eligible**：没有资格成为 Master 节点的节点（例如，数据节点或协调节点）。

### 4. 发起选举
当一个节点发现自己需要进行 Master 选举时（例如，当前 Master 节点不可用），它会发起一个选举过程。选举过程的核心步骤如下：

#### a. 选举投票
所有 Master-Eligible 节点互相发送投票请求。每个节点会根据特定的规则决定是否投票给请求的节点。投票规则包括：

+ **节点状态**：节点必须是 Master-Eligible。
+ **集群状态**：节点必须能够访问集群中的大多数节点（半数以上）。
+ **节点优先级**：可能会考虑节点的启动时间或其他优先级因素。

#### b. 收集投票
每个节点会收集来自其他节点的投票。如果一个节点获得了大多数节点的投票（即超过半数的投票），它就会宣布自己为新的 Master 节点。

### 5. 宣布 Master
一旦一个节点被选为 Master，它会向集群中的所有节点发送一个通知，宣布自己是新的 Master。其他节点会更新其状态，承认新的 Master。

### 6. 更新集群状态
新的 Master 节点会收集集群的最新状态信息，并将其广播给所有节点。这个过程确保所有节点都拥有一致的集群状态视图。

### 7. 处理故障
如果当前的 Master 节点发生故障，剩余的 Master-Eligible 节点会重新发起选举过程，选出一个新的 Master 节点。

### 选举过程示例
以下是一个简单的选举过程示例：

1. **节点 A、B、C 启动**：假设集群中有三个 Master-Eligible 节点 A、B 和 C。
2. **节点 A 发起选举**：节点 A 发现当前没有 Master 节点，发起选举过程。
3. **节点 A 请求投票**：节点 A 向节点 B 和 C 发送投票请求。
4. **节点 B 和 C 投票**：节点 B 和 C 评估节点 A 的请求，并决定投票给节点 A。
5. **节点 A 获得多数投票**：节点 A 获得了节点 B 和 C 的投票（大多数投票），宣布自己为新的 Master 节点。
6. **节点 A 宣布 Master**：节点 A 向节点 B 和 C 发送通知，宣布自己为新的 Master。
7. **集群状态更新**：节点 A 收集集群状态信息并将其广播给所有节点，确保一致的集群状态视图。

### 额外注意事项
+ **最小 Master 节点数**：Elasticsearch 集群配置中可以设置`minimum_master_nodes`参数，确保选举过程中需要至少一定数量的 Master-Eligible 节点投票，防止网络分区导致的脑裂问题。
+ **网络分区处理**：如果集群发生网络分区，只有包含多数节点的分区能够继续进行选举和操作，确保数据一致性。



> 原文: <https://www.yuque.com/jingdianjichi/xyxdsi/ukag6iqg8skl1gem>
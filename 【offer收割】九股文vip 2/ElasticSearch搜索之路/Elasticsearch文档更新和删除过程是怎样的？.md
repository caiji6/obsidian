# 👌Elasticsearch 文档更新和删除过程是怎样的？

### 1. 文档更新过程
Elasticsearch 中的文档更新并不是直接修改原始文档。

#### a. 检索和修改
1. **获取原始文档**：首先，Elasticsearch 会检索到需要更新的文档。
2. **修改文档**：然后，应用更新操作（如字段修改、添加或删除等）来生成一个新的版本的文档。

#### b. 删除旧文档和索引新文档
1. **标记旧文档为删除**：旧文档不会立即从磁盘上删除，而是被标记为删除（逻辑删除）。
2. **索引新文档**：新版本的文档会被索引，存储在同一个索引中，但具有新的版本号。

#### c. 版本控制和冲突检测
1. **版本控制**：每个文档都有一个版本号，更新操作会增加版本号。客户端可以指定版本号来确保更新的原子性和一致性。
2. **冲突检测**：如果在更新过程中发现版本冲突（如并发更新），Elasticsearch 会返回冲突错误，客户端需要处理冲突。

### 2. 文档删除过程
文档删除操作相对简单

#### a. 标记为删除
1. **逻辑删除**：文档删除操作会将目标文档标记为删除，而不是立即从磁盘上移除。这种方式有助于提高删除操作的性能。
2. **物理删除**：实际的物理删除会在段合并（segment merge）过程中进行，段合并是 Elasticsearch 的后台任务，会定期清理被标记为删除的文档。

#### b. 索引更新
1. **更新索引**：删除操作会更新索引元数据，记录文档已被删除。
2. **一致性**：Elasticsearch 会确保在删除操作返回成功之前，删除操作已经被成功应用。



> 原文: <https://www.yuque.com/jingdianjichi/xyxdsi/rgz4ya114oiv743u>
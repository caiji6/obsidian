# 👌es 写数据过程是怎么样的？

### 1. 接收请求
当客户端发送一个写请求（如`index`或`bulk`请求）到 Elasticsearch 集群时，请求会被发送到一个节点，这个节点称为协调节点（Coordinating Node）。

### 2. 文档路由
协调节点根据文档的`_id`和索引的分片数计算出目标分片。这个过程使用哈希算法来确定目标分片。

### 3. 转发请求
协调节点将写请求转发给目标分片的主分片（Primary Shard）的主节点。每个索引在集群中都有一个主分片和多个副本分片（Replica Shard）。

### 4. 主分片处理
主分片接收到写请求后，执行以下操作：

#### a. 预处理
+ **版本检查**：确保文档版本号正确，以防止并发写入冲突。
+ **文档解析**：解析和验证文档数据。

#### b. 写入内存缓冲区
+ **内存缓冲区**：将文档写入内存缓冲区（In-Memory Buffer）。
+ **事务日志**：同时将操作记录写入事务日志（Translog），以确保数据持久性。

### 5. 同步到副本分片
主分片成功处理写请求后，会将请求转发给所有副本分片。副本分片执行与主分片相同的写操作。

### 6. 确认写入
所有副本分片成功写入数据后，会向主分片确认。主分片再向协调节点确认写入成功。最后，协调节点向客户端返回成功响应。

### 7. 刷新和提交
#### a. 刷新
+ **刷新间隔**：默认情况下，每隔 1 秒（可以配置）会执行一次刷新操作，将内存缓冲区中的数据刷新到一个新的段文件（Segment File）中，并更新 Lucene 索引。

#### b. 提交
+ **事务日志提交**：默认每隔 30 分钟（可以配置）或事务日志达到一定大小时，会执行一次提交操作，将事务日志中的数据持久化到磁盘，并清空事务日志。

### 8. 合并段文件
随着不断的写入操作，Elasticsearch 会创建多个段文件。为了优化查询性能，Elasticsearch 会定期执行段文件合并（Merge）操作，将多个小段文件合并成一个大段文件。



> 原文: <https://www.yuque.com/jingdianjichi/xyxdsi/qtulweod341nff1v>
# 👌如何避免消息重复投递或重复消费？

[此处为语雀卡片，点击链接查看](https://www.yuque.com/jingdianjichi/xyxdsi/sh7vy6mchabb0fgg#UqNyq)

# 口语化答案
好的，面试官，重复是在 mq 里比较常见的问题，mq 的重复如果没有做好处理的话，会产生比较大的影响，比如重复扣钱，或者重复减数量之类的操作。一般重复消费的问题发生的比较多，首要保证的就是消费幂等，一个消息应该无论被处理多少次，结果都相同。主要可以通过，唯一标识，建立去重表，或者业务逻辑代码的幂等处理来实现。另一种情况就是投递，这种情况一方面，配合 mq 的投递机制，尽快收到 mq 的确认，可以防止我们多次重试。还可在发送方做好策略处理，比如同样做去重表，也可以避免重复。最后一个就是偏中间价机制方面的，针对有位点概念的 mq，消费者一定要及时的提交位点，防止 mq 假设重启了，位点没更新，则又重复消费的问题。

以上。

# 题目解析
与丢失，顺序消费并称三巨头问题。大家要好好关注一下，不过这道题也好答，方案就这么几个，不多，重复消费这一块会问的比较多。

# 面试得分点
唯一标识，去重表，幂等

# 题目详细答案
## 消息幂等性
消息幂等性是指无论消息被处理多少次，结果都是相同的。实现幂等性是避免重复消费的基础。

主要可以通过如下方式进行实现：

**1、 唯一标识**：每条消息都带有一个唯一标识（如 UUID），在处理消息时，先检查这个标识是否已经处理过。

**2、 去重表**：使用数据库或缓存系统（如 Redis）记录处理过的消息标识，避免重复处理。

**3、 业务逻辑幂等性**：确保业务操作本身是幂等的，例如扣款操作确保同一笔交易不会被重复扣款。

## 消息投递机制
RocketMQ 支持多种消息投递机制，可以根据业务需求选择合适的投递策略。

同步投递确保消息被可靠地发送到 Broker，并且发送方可以收到确认。通过这种方式，可以减少消息丢失的可能性。

RocketMQ 提供了消息重试机制，当消息投递失败时，会自动重试。为了避免重复投递，可以设置合理的重试次数和间隔时间。

## 消费进度管理
消费进度管理是避免重复消费的关键。RocketMQ 通过消费位点（Offset）来管理消费进度。

消费者实例在消费消息后，需要定期提交消费位点到 Broker。这样即使消费者实例重启，也能从上次提交的位置继续消费。

消费位点可以存储在 Broker 或外部存储系统（如数据库、Zookeeper）中。确保消费位点的持久化存储，可以在消费者实例故障恢复后继续消费。



> 原文: <https://www.yuque.com/jingdianjichi/xyxdsi/sh7vy6mchabb0fgg>
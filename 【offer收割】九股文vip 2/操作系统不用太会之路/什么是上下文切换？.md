# 👌什么是上下文切换？

上下文切换（Context Switching）是操作系统在多任务处理环境中，为了在不同进程或线程之间切换执行而保存和恢复CPU状态的过程。这个过程涉及保存当前进程的状态，并加载即将执行的进程的状态，以确保每个进程都能继续从上次中断的地方执行。

### 上下文切换的步骤
1. **保存当前进程的状态**：当操作系统决定中断当前正在运行的进程时，它会保存该进程的上下文信息。
    - 寄存器状态（如通用寄存器、程序计数器、堆栈指针等）
    - 程序状态字（Program Status Word，PSW）
    - 其他相关的硬件状态
2. **选择下一个执行的进程**：操作系统的调度器（Scheduler）根据某种调度算法（如时间片轮转、优先级调度等）选择下一个要执行的进程。
3. **恢复下一个进程的状态**：操作系统将之前保存的下一个进程的上下文信息加载到CPU中，包括寄存器状态和其他硬件状态。
4. **切换到下一个进程执行**：CPU开始执行下一个进程，从该进程上次中断的地方继续运行。

### 上下文切换的类型
1. **进程上下文切换**：在不同进程之间进行切换。由于进程有独立的地址空间，切换时需要保存和恢复更多的状态信息，如内存管理单元（MMU）和地址空间信息。
2. **线程上下文切换**：在同一进程的不同线程之间进行切换。由于线程共享进程的地址空间和资源，切换时只需保存和恢复较少的状态信息，如寄存器状态和堆栈指针。

### 上下文切换的开销
上下文切换是一个开销较大的操作，因为它涉及多个步骤和状态信息的保存与恢复。

1. **CPU开销**：保存和恢复寄存器状态、程序计数器等。
2. **内存开销**：切换进程时可能涉及虚拟内存页表的切换和缓存（如TLB）的刷新。
3. **时间开销**：上下文切换需要时间，频繁的上下文切换会导致系统性能下降。

### 上下文切换的优化
为了减少上下文切换的开销，通常会采用以下优化策略：

1. **减少上下文切换的频率**：通过优化调度算法，减少不必要的上下文切换。
2. **硬件支持**：现代CPU通常提供硬件支持，如快速上下文切换和多级缓存（如TLB）来加速上下文切换过程。
3. **轻量级线程**：使用轻量级线程（如协程）来减少线程上下文切换的开销。



> 原文: <https://www.yuque.com/jingdianjichi/xyxdsi/bs2uz7pzdlg1q0dt>
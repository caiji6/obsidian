# 👌进程与线程的切换流程？

### 进程切换（Context Switch）
进程切换是指操作系统从一个进程切换到另一个进程的过程。这个过程涉及保存当前进程的状态并恢复下一个进程的状态。进程切换通常比线程切换开销更大，因为进程拥有独立的地址空间和资源。

#### 进程切换的基本流程：
1. **保存当前进程状态**：
    - 将当前进程的寄存器状态（包括程序计数器、堆栈指针等）保存到进程控制块（PCB）。
    - 保存当前进程的内存映射信息（如页表）。
2. **更新进程调度信息**：
    - 将当前进程的状态标记为“等待”或“就绪”。
    - 从就绪队列中选择下一个要运行的进程。
3. **加载下一个进程状态**：
    - 将下一个进程的状态从其PCB中恢复到寄存器。
    - 更新内存管理单元（MMU）以使用下一个进程的地址空间（页表）。
4. **切换上下文**：
    - 将CPU控制权交给下一个进程，开始执行该进程的代码。

### 线程切换（Thread Switch）
线程切换是指操作系统在同一进程内从一个线程切换到另一个线程的过程。因为线程共享同一个进程的地址空间和资源，线程切换的开销通常比进程切换小。

#### 线程切换的基本流程：
1. **保存当前线程状态**：
    - 将当前线程的寄存器状态（包括程序计数器、堆栈指针等）保存到线程控制块（TCB）。
2. **更新线程调度信息**：
    - 将当前线程的状态标记为“等待”或“就绪”。
    - 从就绪队列中选择下一个要运行的线程。
3. **加载下一个线程状态**：
    - 将下一个线程的状态从其TCB中恢复到寄存器。
4. **切换上下文**：
    - 将CPU控制权交给下一个线程，开始执行该线程的代码。

### 进程切换与线程切换的对比
| 特性 | 进程切换 | 线程切换 |
| --- | --- | --- |
| 地址空间 | 切换进程时，需要切换地址空间 | 线程共享同一进程的地址空间，无需切换 |
| 开销 | 高（涉及内存管理单元和页表切换） | 低（仅涉及寄存器和堆栈指针切换） |
| 资源管理 | 每个进程有独立的资源（文件描述符等） | 线程共享进程的资源 |
| 使用场景 | 适用于独立的任务 | 适用于需要频繁切换的轻量级任务 |


### 实际操作中的细节
+ **中断处理**：无论是进程切换还是线程切换，通常都是由时钟中断或其他中断触发的。中断处理程序会保存当前的执行上下文，然后调用调度器进行切换。
+ **调度算法**：操作系统使用调度算法（如轮转调度、优先级调度）来决定下一个要运行的进程或线程。
+ **同步机制**：在多线程环境中，线程切换还需要考虑同步机制，以确保共享资源的安全访问。



> 原文: <https://www.yuque.com/jingdianjichi/xyxdsi/rfiq7rhn9f37h6td>
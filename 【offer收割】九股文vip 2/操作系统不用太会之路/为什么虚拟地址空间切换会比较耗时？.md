# 👌为什么虚拟地址空间切换会比较耗时？

虚拟地址空间切换比较耗时的原因主要在于它涉及到大量的系统状态和资源的保存与恢复。

### 1. 页表切换
每个进程都有自己独立的虚拟地址空间，这意味着每个进程都有自己的页表（Page Table）。页表是用于将虚拟地址映射到物理地址的结构。

+ **页表切换**：当操作系统切换到一个新的进程时，需要切换当前使用的页表。现代处理器使用一个专门的寄存器（如x86架构中的CR3寄存器）来指向当前进程的页表根。切换页表意味着需要更新这个寄存器。
+ **TLB刷新**：处理器通常使用一个称为翻译后备缓冲区（TLB）的高速缓存来加速虚拟地址到物理地址的转换。切换页表后，TLB中的内容可能不再有效，需要刷新TLB。这会导致在新的页表加载到TLB之前的内存访问变慢，因为每次内存访问都需要重新查找页表。

### 2. 缓存一致性
现代处理器使用多级缓存（L1、L2、L3）来提高内存访问速度。不同进程可能会使用不同的内存区域，因此在进程切换时也可能需要处理缓存一致性问题。

+ **缓存刷新**：在某些情况下，可能需要刷新缓存以确保数据一致性，特别是在多处理器系统中。
+ **缓存命中率降低**：新的进程可能会访问不同的内存区域，这会导致缓存命中率降低，从而影响性能。

### 3. 内核态和用户态切换
进程切换通常伴随着从用户态到内核态的切换，反之亦然。

+ **内核态切换**：切换到内核态需要保存和恢复用户态的寄存器状态，并加载内核态的寄存器状态。
+ **用户态切换**：从内核态切换回用户态也需要类似的操作。

### 4. 进程控制块管理
每个进程都有一个进程控制块（PCB），其中保存了进程的所有状态信息，包括寄存器状态、程序计数器、堆栈指针、内存管理信息等。

+ **保存和恢复状态**：在进程切换时，需要将当前进程的状态保存到其PCB中，并从下一个进程的PCB中恢复状态。这涉及到大量的寄存器操作和内存访问。

### 5. 资源管理
进程拥有独立的资源，如文件描述符、信号处理器、打开的文件等。

+ **资源切换**：切换进程时，操作系统需要管理这些资源的状态。例如，文件描述符表需要从当前进程切换到下一个进程。

### 6. 系统调度
操作系统的调度程序需要选择下一个要运行的进程，这涉及到复杂的调度算法和队列管理。

+ **调度开销**：调度程序需要遍历就绪队列、计算优先级、处理时间片等，这些操作也会增加一些开销。



> 原文: <https://www.yuque.com/jingdianjichi/xyxdsi/cggz7praqbey3olz>
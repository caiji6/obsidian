# ğŸ‘Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¦‚ä½•æ£€æµ‹å’Œå¤„ç†äº‹åŠ¡çš„è¶…æ—¶é—®é¢˜ï¼Ÿ

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œäº‹åŠ¡è¶…æ—¶é—®é¢˜æ˜¯ä¸€ä¸ªå¸¸è§ä¸”å¤æ‚çš„é—®é¢˜ã€‚ç”±äºåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å„ä¸ªèŠ‚ç‚¹å¯èƒ½å­˜åœ¨ç½‘ç»œå»¶è¿Ÿã€èŠ‚ç‚¹æ•…éšœç­‰æƒ…å†µï¼Œäº‹åŠ¡å¯èƒ½æ— æ³•åœ¨é¢„æœŸæ—¶é—´å†…å®Œæˆã€‚å› æ­¤ï¼Œæ£€æµ‹å’Œå¤„ç†äº‹åŠ¡è¶…æ—¶å¯¹äºä¿è¯ç³»ç»Ÿçš„ä¸€è‡´æ€§å’Œå¯ç”¨æ€§è‡³å…³é‡è¦ã€‚

### äº‹åŠ¡è¶…æ—¶æ£€æµ‹å’Œå¤„ç†çš„ç­–ç•¥
1. **äº‹åŠ¡è¶…æ—¶è®¾ç½®**ï¼šä¸ºæ¯ä¸ªäº‹åŠ¡è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼ˆTimeoutï¼‰ã€‚å¦‚æœäº‹åŠ¡åœ¨æŒ‡å®šæ—¶é—´å†…æœªå®Œæˆï¼Œåˆ™è®¤ä¸ºè¯¥äº‹åŠ¡è¶…æ—¶ã€‚
2. **å®šæœŸæ£€æŸ¥**ï¼šä½¿ç”¨å®šæœŸæ£€æŸ¥æœºåˆ¶ï¼Œå®šæœŸæ‰«ææœªå®Œæˆçš„äº‹åŠ¡ï¼Œæ£€æµ‹æ˜¯å¦æœ‰äº‹åŠ¡å·²ç»è¶…æ—¶ã€‚
3. **å›æ»šæˆ–è¡¥å¿**ï¼šå¯¹äºæ£€æµ‹åˆ°è¶…æ—¶çš„äº‹åŠ¡ï¼Œé‡‡å–å›æ»šæˆ–è¡¥å¿æ“ä½œï¼Œä»¥æ¢å¤ç³»ç»Ÿçš„ä¸€è‡´æ€§ã€‚

### å…·ä½“å®ç°æ–¹æ³•
#### 1. è®¾ç½®äº‹åŠ¡è¶…æ—¶æ—¶é—´
åœ¨å¼€å§‹äº‹åŠ¡æ—¶ï¼Œå¯ä»¥ä¸ºäº‹åŠ¡è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´ã€‚ä¾‹å¦‚ï¼š

```plain
public void startTransaction(Transaction transaction, long timeoutMillis) {
    transaction.setStartTime(System.currentTimeMillis());
    transaction.setTimeoutMillis(timeoutMillis);
}
```

#### 2. å®šæœŸæ£€æŸ¥äº‹åŠ¡çŠ¶æ€
ä½¿ç”¨ä¸€ä¸ªåå°çº¿ç¨‹æˆ–è°ƒåº¦ä»»åŠ¡ï¼Œå®šæœŸæ£€æŸ¥æœªå®Œæˆçš„äº‹åŠ¡ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰äº‹åŠ¡å·²ç»è¶…æ—¶ã€‚

```plain
public class TransactionManager {
    private List<Transaction> transactions = new ArrayList<>();
    private ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1);

    public TransactionManager() {
        scheduler.scheduleAtFixedRate(this::checkTimeouts, 0, 1, TimeUnit.SECONDS);
    }

    public void startTransaction(Transaction transaction, long timeoutMillis) {
        transaction.setStartTime(System.currentTimeMillis());
        transaction.setTimeoutMillis(timeoutMillis);
        transactions.add(transaction);
    }

    private void checkTimeouts() {
        long currentTime = System.currentTimeMillis();
        for (Transaction transaction : transactions) {
            if (transaction.getStartTime() + transaction.getTimeoutMillis() < currentTime) {
                handleTimeout(transaction);
            }
        }
    }

    private void handleTimeout(Transaction transaction) {
        // å›æ»šæˆ–è¡¥å¿æ“ä½œ
        transaction.rollback();
        transactions.remove(transaction);
    }
}
```

#### 3. å›æ»šæˆ–è¡¥å¿æ“ä½œ
å¯¹äºè¶…æ—¶çš„äº‹åŠ¡ï¼Œé€šå¸¸éœ€è¦æ‰§è¡Œå›æ»šæˆ–è¡¥å¿æ“ä½œï¼Œä»¥æ¢å¤ç³»ç»Ÿçš„ä¸€è‡´æ€§ã€‚

```plain
public class Transaction {
    private long startTime;
    private long timeoutMillis;

    public void setStartTime(long startTime) {
        this.startTime = startTime;
    }

    public void setTimeoutMillis(long timeoutMillis) {
        this.timeoutMillis = timeoutMillis;
    }

    public long getStartTime() {
        return startTime;
    }

    public long getTimeoutMillis() {
        return timeoutMillis;
    }

    public void rollback() {
        // æ‰§è¡Œå›æ»šæ“ä½œ
    }
}
```

### å…¶ä»–è€ƒè™‘å› ç´ 
#### 1. åˆ†å¸ƒå¼é”
åœ¨åˆ†å¸ƒå¼äº‹åŠ¡ä¸­ï¼Œä½¿ç”¨åˆ†å¸ƒå¼é”å¯ä»¥é˜²æ­¢å¤šä¸ªèŠ‚ç‚¹åŒæ—¶æ“ä½œåŒä¸€èµ„æºï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚åˆ†å¸ƒå¼é”é€šå¸¸éœ€è¦è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œä»¥é˜²æ­¢æ­»é”æƒ…å†µã€‚

#### 2. å¹‚ç­‰æ€§
åœ¨å¤„ç†è¶…æ—¶äº‹åŠ¡æ—¶ï¼Œç¡®ä¿æ“ä½œçš„å¹‚ç­‰æ€§éå¸¸é‡è¦ã€‚å¹‚ç­‰æ€§ä¿è¯å³ä½¿åŒä¸€æ“ä½œè¢«æ‰§è¡Œå¤šæ¬¡ï¼Œç»“æœä¹Ÿæ˜¯ç›¸åŒçš„ã€‚è¿™å¯¹äºå›æ»šæˆ–è¡¥å¿æ“ä½œå°¤ä¸ºé‡è¦ã€‚

#### 3. åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®
ä½¿ç”¨åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®ï¼ˆå¦‚Paxosã€Raftï¼‰æ¥åè°ƒäº‹åŠ¡çš„æäº¤å’Œå›æ»šï¼Œå¯ä»¥æé«˜ç³»ç»Ÿçš„ä¸€è‡´æ€§å’Œå¯é æ€§ã€‚è¿™äº›åè®®é€šå¸¸ä¼šå¤„ç†èŠ‚ç‚¹æ•…éšœå’Œç½‘ç»œåˆ†åŒºé—®é¢˜ï¼Œç¡®ä¿ç³»ç»Ÿåœ¨å„ç§å¼‚å¸¸æƒ…å†µä¸‹ä»èƒ½ä¿æŒä¸€è‡´æ€§ã€‚

#### 4. æ—¥å¿—è®°å½•
åœ¨å¤„ç†äº‹åŠ¡æ—¶ï¼Œè®°å½•æ“ä½œæ—¥å¿—æ˜¯éå¸¸é‡è¦çš„ã€‚æ—¥å¿—å¯ä»¥å¸®åŠ©åœ¨äº‹åŠ¡è¶…æ—¶æˆ–å¤±è´¥æ—¶ï¼Œè¿›è¡Œå›æ»šæˆ–è¡¥å¿æ“ä½œã€‚æ­¤å¤–ï¼Œæ—¥å¿—è¿˜å¯ä»¥ç”¨äºæ•…éšœæ¢å¤å’Œå®¡è®¡ã€‚



> åŸæ–‡: <https://www.yuque.com/jingdianjichi/xyxdsi/fh4aq5gwy1wfgt7u>
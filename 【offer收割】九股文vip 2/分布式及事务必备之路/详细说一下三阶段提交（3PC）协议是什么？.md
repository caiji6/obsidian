# ðŸ‘Œè¯¦ç»†è¯´ä¸€ä¸‹ä¸‰é˜¶æ®µæäº¤ï¼ˆ3PCï¼‰åè®®æ˜¯ä»€ä¹ˆï¼Ÿ

ä¸‰é˜¶æ®µæäº¤åè®®ï¼ˆ3PCï¼ŒThree-Phase Commitï¼‰æ˜¯å¯¹ä¸¤é˜¶æ®µæäº¤åè®®ï¼ˆ2PCï¼‰çš„æ”¹è¿›ï¼Œç”¨äºŽè§£å†³2PCä¸­çš„ä¸€äº›ç¼ºç‚¹ï¼Œå¦‚å•ç‚¹æ•…éšœå’Œé˜»å¡žé—®é¢˜ã€‚3PCé€šè¿‡å¼•å…¥ä¸€ä¸ªé¢å¤–çš„é˜¶æ®µæ¥å‡å°‘å‚ä¸Žè€…åœ¨ç­‰å¾…åè°ƒè€…å†³ç­–æ—¶çš„é˜»å¡žæ—¶é—´ï¼Œå¹¶å¢žåŠ ç³»ç»Ÿçš„å®¹é”™èƒ½åŠ›ã€‚

### 3PCçš„ä¸‰ä¸ªé˜¶æ®µ
1. **CanCommité˜¶æ®µï¼ˆè¯¢é—®é˜¶æ®µï¼‰**
2. **PreCommité˜¶æ®µï¼ˆé¢„æäº¤é˜¶æ®µï¼‰**
3. **DoCommité˜¶æ®µï¼ˆæäº¤é˜¶æ®µï¼‰**

### è¯¦ç»†æµç¨‹
#### 1. CanCommité˜¶æ®µï¼ˆè¯¢é—®é˜¶æ®µï¼‰
åè°ƒè€…å‘æ‰€æœ‰å‚ä¸Žè€…å‘é€ä¸€ä¸ª`CanCommit`è¯·æ±‚ï¼Œè¯¢é—®ä»–ä»¬æ˜¯å¦å¯ä»¥å‡†å¤‡æäº¤äº‹åŠ¡ã€‚æ¯ä¸ªå‚ä¸Žè€…åœ¨æ”¶åˆ°`CanCommit`è¯·æ±‚åŽï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

+ **è®°å½•æ—¥å¿—**ï¼šè®°å½•æ”¶åˆ°çš„`CanCommit`è¯·æ±‚ã€‚
+ **åˆ¤æ–­æ˜¯å¦å¯ä»¥æäº¤**ï¼šæ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰§è¡Œäº‹åŠ¡æ“ä½œã€‚
+ **å“åº”åè°ƒè€…**ï¼šå¦‚æžœå¯ä»¥å‡†å¤‡æäº¤ï¼Œè¿”å›ž`Yes`ï¼›å¦åˆ™ï¼Œè¿”å›ž`No`ã€‚

#### 2. PreCommité˜¶æ®µï¼ˆé¢„æäº¤é˜¶æ®µï¼‰
å¦‚æžœåè°ƒè€…ä»Žæ‰€æœ‰å‚ä¸Žè€…å¤„éƒ½æ”¶åˆ°`Yes`å“åº”ï¼Œåˆ™è¿›å…¥`PreCommit`é˜¶æ®µã€‚å¦‚æžœæœ‰ä»»ä½•å‚ä¸Žè€…è¿”å›ž`No`ï¼Œåˆ™åè°ƒè€…å‘é€`Abort`è¯·æ±‚ï¼Œäº‹åŠ¡ç»ˆæ­¢ã€‚

åœ¨`PreCommit`é˜¶æ®µï¼Œåè°ƒè€…æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

+ **è®°å½•æ—¥å¿—**ï¼šè®°å½•å‡†å¤‡è¿›å…¥é¢„æäº¤çŠ¶æ€ã€‚
+ **å‘é€é¢„æäº¤è¯·æ±‚**ï¼šå‘æ‰€æœ‰å‚ä¸Žè€…å‘é€`PreCommit`è¯·æ±‚ã€‚

å‚ä¸Žè€…åœ¨æ”¶åˆ°`PreCommit`è¯·æ±‚åŽï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

+ **è®°å½•æ—¥å¿—**ï¼šè®°å½•è¿›å…¥é¢„æäº¤çŠ¶æ€ã€‚
+ **å‡†å¤‡æäº¤**ï¼šæ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œä½†ä¸æäº¤ã€‚
+ **å‘é€å“åº”**ï¼šç¡®è®¤å·²è¿›å…¥é¢„æäº¤çŠ¶æ€ï¼Œè¿”å›ž`ACK`ã€‚

#### 3. DoCommité˜¶æ®µï¼ˆæäº¤é˜¶æ®µï¼‰
åœ¨`DoCommit`é˜¶æ®µï¼Œåè°ƒè€…æ ¹æ®å‚ä¸Žè€…çš„å“åº”å†³å®šäº‹åŠ¡çš„æœ€ç»ˆç»“æžœã€‚å¦‚æžœæ‰€æœ‰å‚ä¸Žè€…éƒ½è¿”å›ž`ACK`ï¼Œåˆ™åè°ƒè€…å‘é€`DoCommit`è¯·æ±‚ï¼›å¦‚æžœæœ‰ä»»ä½•å‚ä¸Žè€…æœªè¿”å›ž`ACK`ï¼Œåˆ™åè°ƒè€…å‘é€`Abort`è¯·æ±‚ã€‚

+ **æäº¤äº‹åŠ¡**ï¼šå¦‚æžœæ‰€æœ‰å‚ä¸Žè€…éƒ½è¿”å›ž`ACK`ï¼Œåè°ƒè€…å‘æ‰€æœ‰å‚ä¸Žè€…å‘é€`DoCommit`è¯·æ±‚ã€‚å‚ä¸Žè€…åœ¨æ”¶åˆ°`DoCommit`è¯·æ±‚åŽï¼Œæäº¤äº‹åŠ¡å¹¶é‡Šæ”¾èµ„æºã€‚
+ **å›žæ»šäº‹åŠ¡**ï¼šå¦‚æžœæœ‰ä»»ä½•å‚ä¸Žè€…æœªè¿”å›ž`ACK`ï¼Œåè°ƒè€…å‘æ‰€æœ‰å‚ä¸Žè€…å‘é€`Abort`è¯·æ±‚ã€‚å‚ä¸Žè€…åœ¨æ”¶åˆ°`Abort`è¯·æ±‚åŽï¼Œå›žæ»šäº‹åŠ¡å¹¶é‡Šæ”¾èµ„æºã€‚

### è¯¦ç»†æµç¨‹å›¾
```plain
Coordinator                  Participant 1                  Participant 2
     |                            |                             |
     |------ CanCommit Request -->|                             |
     |                            |                             |
     |<------ Yes/No Response ----|                             |
     |                            |                             |
     |                            |------ CanCommit Request --->|
     |                            |                             |
     |                            |<------ Yes/No Response -----|
     |                            |                             |
     |------ PreCommit Request -->|                             |
     |                            |                             |
     |<------ ACK Response -------|                             |
     |                            |                             |
     |                            |------ PreCommit Request --->|
     |                            |                             |
     |                            |<------ ACK Response --------|
     |                            |                             |
     |------ DoCommit Request --->|                             |
     |                            |                             |
     |                            |------ DoCommit Request ---->|
     |                            |                             |
     |                            |                             |
```

### 3PCçš„ä¼˜ç‚¹å’Œç¼ºç‚¹
**ä¼˜ç‚¹ï¼š**

+ **å‡å°‘é˜»å¡žæ—¶é—´**ï¼šé€šè¿‡å¼•å…¥é¢„æäº¤é˜¶æ®µï¼Œå‡å°‘äº†å‚ä¸Žè€…åœ¨ç­‰å¾…åè°ƒè€…å†³ç­–æ—¶çš„é˜»å¡žæ—¶é—´ã€‚
+ **æé«˜å®¹é”™èƒ½åŠ›**ï¼šåœ¨åè°ƒè€…æ•…éšœçš„æƒ…å†µä¸‹ï¼Œå‚ä¸Žè€…å¯ä»¥æ ¹æ®é¢„æäº¤çŠ¶æ€å†³å®šæ˜¯å¦æäº¤äº‹åŠ¡ï¼Œä»Žè€Œæé«˜ç³»ç»Ÿçš„å®¹é”™èƒ½åŠ›ã€‚

**ç¼ºç‚¹ï¼š**

+ **å¤æ‚æ€§å¢žåŠ **ï¼šç›¸æ¯”2PCï¼Œ3PCçš„å®žçŽ°æ›´ä¸ºå¤æ‚ã€‚
+ **ç½‘ç»œå¼€é”€å¢žåŠ **ï¼šç”±äºŽå¢žåŠ äº†ä¸€ä¸ªé¢å¤–çš„é˜¶æ®µï¼Œ3PCçš„ç½‘ç»œé€šä¿¡å¼€é”€ä¹Ÿç›¸åº”å¢žåŠ ã€‚

### æ€»ç»“
ä¸‰é˜¶æ®µæäº¤åè®®é€šè¿‡å¼•å…¥é¢„æäº¤é˜¶æ®µï¼Œè§£å†³äº†ä¸¤é˜¶æ®µæäº¤åè®®ä¸­çš„ä¸€äº›ç¼ºç‚¹ï¼Œå¦‚å•ç‚¹æ•…éšœå’Œé˜»å¡žé—®é¢˜ã€‚å°½ç®¡3PCå¢žåŠ äº†å®žçŽ°çš„å¤æ‚æ€§å’Œç½‘ç»œå¼€é”€ï¼Œä½†åœ¨éœ€è¦é«˜å¯é æ€§å’Œå®¹é”™èƒ½åŠ›çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œ3PCæ˜¯ä¸€ç§æœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚



> åŽŸæ–‡: <https://www.yuque.com/jingdianjichi/xyxdsi/uowl7cuins71d6v7>
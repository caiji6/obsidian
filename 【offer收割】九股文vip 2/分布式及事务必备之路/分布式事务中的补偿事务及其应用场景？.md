# ğŸ‘Œåˆ†å¸ƒå¼äº‹åŠ¡ä¸­çš„è¡¥å¿äº‹åŠ¡åŠå…¶åº”ç”¨åœºæ™¯ï¼Ÿ

è¡¥å¿äº‹åŠ¡ï¼ˆCompensating Transactionsï¼‰æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ç®¡ç†ä¸­çš„ä¸€ç§é‡è¦æœºåˆ¶ï¼Œç”¨äºåœ¨å‘ç”Ÿé”™è¯¯æˆ–éœ€è¦æ’¤é”€æ“ä½œæ—¶ï¼Œé€šè¿‡æ‰§è¡Œè¡¥å¿æ“ä½œæ¥æ¢å¤ç³»ç»Ÿçš„ä¸€è‡´æ€§ã€‚è¡¥å¿äº‹åŠ¡å¹¶ä¸æ˜¯ç®€å•çš„å›æ»šï¼Œè€Œæ˜¯é€šè¿‡æ‰§è¡Œä¸åŸäº‹åŠ¡ç›¸åçš„æ“ä½œï¼Œæ¥æ’¤é”€å·²ç»å®Œæˆçš„äº‹åŠ¡æ­¥éª¤ã€‚

### è¡¥å¿äº‹åŠ¡çš„æ¦‚å¿µ
è¡¥å¿äº‹åŠ¡çš„åŸºæœ¬æ€æƒ³æ˜¯ï¼šå¯¹äºæ¯ä¸ªå¯èƒ½å¤±è´¥çš„æ“ä½œï¼Œéƒ½å®šä¹‰ä¸€ä¸ªå¯¹åº”çš„è¡¥å¿æ“ä½œï¼Œä»¥ä¾¿åœ¨éœ€è¦æ’¤é”€æ—¶æ‰§è¡Œã€‚è¡¥å¿æ“ä½œé€šå¸¸æ˜¯åŸæ“ä½œçš„åå‘æ“ä½œï¼Œä½†å¹¶ä¸æ€»æ˜¯å®Œå…¨å¯¹ç§°çš„ï¼Œå› ä¸ºæŸäº›æ“ä½œå¯èƒ½æ˜¯ä¸å¯é€†çš„ã€‚

### è¡¥å¿äº‹åŠ¡çš„å·¥ä½œæµç¨‹
1. **å¼€å§‹äº‹åŠ¡**ï¼šå¯åŠ¨åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œæ‰§è¡Œä¸€ç³»åˆ—æ“ä½œã€‚
2. **è®°å½•æ“ä½œ**ï¼šæ¯æ‰§è¡Œä¸€ä¸ªæ“ä½œï¼Œè®°å½•è¯¥æ“ä½œåŠå…¶å¯¹åº”çš„è¡¥å¿æ“ä½œã€‚
3. **æ£€æµ‹é”™è¯¯**ï¼šå¦‚æœåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æŸä¸ªæ“ä½œå¤±è´¥ï¼Œæˆ–è€…åœ¨äº‹åŠ¡ç»“æŸæ—¶å‘ç°æ•°æ®ä¸ä¸€è‡´ï¼Œéœ€è¦è¿›è¡Œè¡¥å¿ã€‚
4. **æ‰§è¡Œè¡¥å¿**ï¼šæŒ‰ç…§ç›¸åçš„é¡ºåºæ‰§è¡Œè¡¥å¿æ“ä½œï¼Œä»¥æ’¤é”€å·²ç»å®Œæˆçš„æ“ä½œï¼Œæ¢å¤ç³»ç»Ÿä¸€è‡´æ€§ã€‚

### è¡¥å¿äº‹åŠ¡çš„åº”ç”¨åœºæ™¯
è¡¥å¿äº‹åŠ¡é€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š

1. **é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡**ï¼šåœ¨æŸäº›ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œäº‹åŠ¡å¯èƒ½éœ€è¦é•¿æ—¶é—´è¿è¡Œï¼Œä¾‹å¦‚è·¨å¤šä¸ªç³»ç»Ÿçš„å¤æ‚ä¸šåŠ¡æµç¨‹ã€‚ä¼ ç»Ÿçš„ä¸¤é˜¶æ®µæäº¤åè®®åœ¨è¿™ç§æƒ…å†µä¸‹å¯èƒ½å¯¼è‡´èµ„æºé•¿æ—¶é—´é”å®šï¼Œè€Œè¡¥å¿äº‹åŠ¡å¯ä»¥åœ¨æ¯ä¸ªæ­¥éª¤å®Œæˆåé‡Šæ”¾èµ„æºï¼Œå¹¶åœ¨éœ€è¦æ—¶è¿›è¡Œè¡¥å¿ã€‚
2. **åˆ†å¸ƒå¼ç³»ç»Ÿ**ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸åŒèŠ‚ç‚¹å¯èƒ½å…·æœ‰ä¸åŒçš„äº‹åŠ¡ç®¡ç†æœºåˆ¶ï¼Œä½¿ç”¨è¡¥å¿äº‹åŠ¡å¯ä»¥æ›´çµæ´»åœ°å¤„ç†è·¨èŠ‚ç‚¹çš„äº‹åŠ¡ä¸€è‡´æ€§é—®é¢˜ã€‚
3. **å¾®æœåŠ¡æ¶æ„**ï¼šåœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œæ¯ä¸ªæœåŠ¡é€šå¸¸æ˜¯ç‹¬ç«‹çš„ï¼Œä½¿ç”¨è¡¥å¿äº‹åŠ¡å¯ä»¥åœ¨å¤šä¸ªæœåŠ¡ä¹‹é—´åè°ƒäº‹åŠ¡æ“ä½œï¼Œç¡®ä¿ç³»ç»Ÿæ•´ä½“çš„ä¸€è‡´æ€§ã€‚
4. **ä¸å¯é€†æ“ä½œ**ï¼šæŸäº›æ“ä½œæ˜¯ä¸å¯é€†çš„ï¼ˆä¾‹å¦‚å‘é€é‚®ä»¶ã€è°ƒç”¨å¤–éƒ¨APIï¼‰ï¼Œé€šè¿‡å®šä¹‰è¡¥å¿æ“ä½œï¼Œå¯ä»¥åœ¨éœ€è¦æ—¶é‡‡å–é€‚å½“çš„æªæ–½ï¼ˆä¾‹å¦‚å‘é€å–æ¶ˆé‚®ä»¶ã€è°ƒç”¨å¤–éƒ¨APIæ’¤é”€æ“ä½œï¼‰ã€‚

### è¡¥å¿äº‹åŠ¡çš„ç¤ºä¾‹
å‡è®¾æœ‰ä¸€ä¸ªåœ¨çº¿è´­ç‰©ç³»ç»Ÿï¼Œç”¨æˆ·ä¸‹è®¢å•åéœ€è¦è¿›è¡Œä»¥ä¸‹æ“ä½œï¼š

1. æ‰£å‡åº“å­˜
2. æ‰£å‡ç”¨æˆ·è´¦æˆ·ä½™é¢
3. ç”Ÿæˆè®¢å•è®°å½•

å¦‚æœåœ¨ä»»ä½•ä¸€æ­¥æ“ä½œå¤±è´¥ï¼Œéœ€è¦æ’¤é”€ä¹‹å‰çš„æ“ä½œã€‚

```plain
public class OrderService {
    private InventoryService inventoryService;
    private AccountService accountService;
    private OrderRepository orderRepository;

    public void placeOrder(Order order) {
        try {
            // Step 1: æ‰£å‡åº“å­˜
            inventoryService.deductInventory(order);
            // è®°å½•è¡¥å¿æ“ä½œ
            Runnable compensation1 = () -> inventoryService.addInventory(order);

            // Step 2: æ‰£å‡ç”¨æˆ·è´¦æˆ·ä½™é¢
            accountService.deductBalance(order);
            // è®°å½•è¡¥å¿æ“ä½œ
            Runnable compensation2 = () -> accountService.addBalance(order);

            // Step 3: ç”Ÿæˆè®¢å•è®°å½•
            orderRepository.saveOrder(order);
            // è®°å½•è¡¥å¿æ“ä½œ
            Runnable compensation3 = () -> orderRepository.deleteOrder(order);

            // äº‹åŠ¡æˆåŠŸï¼Œæ¸…é™¤è¡¥å¿æ“ä½œè®°å½•
            clearCompensations();
        } catch (Exception e) {
            // æ‰§è¡Œè¡¥å¿æ“ä½œ
            executeCompensations();
        }
    }

    private List<Runnable> compensations = new ArrayList<>();

    private void addCompensation(Runnable compensation) {
        compensations.add(compensation);
    }

    private void clearCompensations() {
        compensations.clear();
    }

    private void executeCompensations() {
        for (int i = compensations.size() - 1; i >= 0; i--) {
            compensations.get(i).run();
        }
    }
}
```



> åŸæ–‡: <https://www.yuque.com/jingdianjichi/xyxdsi/yqeof4dvl8puq56r>
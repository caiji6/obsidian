# ğŸ‘Œå¦‚ä½•å¤„ç†åˆ†å¸ƒå¼äº‹åŠ¡ä¸­çš„ç½‘ç»œåˆ†åŒºé—®é¢˜ï¼Ÿ

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç½‘ç»œåˆ†åŒºï¼ˆNetwork Partitionï¼‰æ˜¯æŒ‡ç³»ç»Ÿä¸­æŸäº›èŠ‚ç‚¹ä¹‹é—´çš„ç½‘ç»œé€šä¿¡ä¸­æ–­ï¼Œå¯¼è‡´è¿™äº›èŠ‚ç‚¹æ— æ³•ç›¸äº’é€šä¿¡ã€‚ç½‘ç»œåˆ†åŒºæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿé¢ä¸´çš„å¸¸è§é—®é¢˜ä¹‹ä¸€ã€‚

### ç½‘ç»œåˆ†åŒºé—®é¢˜çš„æŒ‘æˆ˜
1. **æ•°æ®ä¸€è‡´æ€§**ï¼šç½‘ç»œåˆ†åŒºå¯èƒ½å¯¼è‡´ä¸åŒèŠ‚ç‚¹ä¸Šçš„æ•°æ®çŠ¶æ€ä¸ä¸€è‡´ã€‚
2. **äº‹åŠ¡å¤„ç†**ï¼šåœ¨ç½‘ç»œåˆ†åŒºæƒ…å†µä¸‹ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡å¯èƒ½æ— æ³•é¡ºåˆ©å®Œæˆï¼Œå¯¼è‡´éƒ¨åˆ†æäº¤æˆ–éƒ¨åˆ†å›æ»šçš„æƒ…å†µã€‚
3. **ç³»ç»Ÿå¯ç”¨æ€§**ï¼šç½‘ç»œåˆ†åŒºå¯èƒ½å¯¼è‡´éƒ¨åˆ†ç³»ç»ŸåŠŸèƒ½ä¸å¯ç”¨ï¼Œä»è€Œå½±å“ç”¨æˆ·ä½“éªŒã€‚

### å¤„ç†ç½‘ç»œåˆ†åŒºé—®é¢˜çš„æ–¹æ³•
å¤„ç†ç½‘ç»œåˆ†åŒºé—®é¢˜é€šå¸¸éœ€è¦åœ¨ä¸€è‡´æ€§ã€å¯ç”¨æ€§å’Œåˆ†åŒºå®¹å¿æ€§ï¼ˆCAPå®šç†ï¼‰ä¹‹é—´è¿›è¡Œæƒè¡¡ã€‚ä»¥ä¸‹æ˜¯å‡ ç§å¸¸è§çš„æ–¹æ³•ï¼š

1. **CAPå®šç†çš„æƒè¡¡**ï¼š
    - **ä¸€è‡´æ€§ä¼˜å…ˆï¼ˆCPï¼‰**ï¼šç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§ï¼Œå³ä½¿åœ¨ç½‘ç»œåˆ†åŒºæœŸé—´æŸäº›æœåŠ¡ä¸å¯ç”¨ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨å¼ºä¸€è‡´æ€§çš„æ•°æ®åº“ç³»ç»Ÿï¼ˆå¦‚ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“ï¼‰æ¥ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼Œä½†å¯èƒ½ä¼šç‰ºç‰²éƒ¨åˆ†å¯ç”¨æ€§ã€‚
    - **å¯ç”¨æ€§ä¼˜å…ˆï¼ˆAPï¼‰**ï¼šç¡®ä¿ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ï¼Œå³ä½¿åœ¨ç½‘ç»œåˆ†åŒºæœŸé—´å…è®¸æ•°æ®ä¸ä¸€è‡´ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨æœ€ç»ˆä¸€è‡´æ€§çš„æ•°æ®åº“ç³»ç»Ÿï¼ˆå¦‚NoSQLæ•°æ®åº“ï¼‰æ¥ç¡®ä¿ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ï¼Œä½†å¯èƒ½ä¼šæœ‰çŸ­æš‚çš„æ•°æ®ä¸ä¸€è‡´ã€‚
2. **ä¸¤é˜¶æ®µæäº¤åè®®ï¼ˆ2PCï¼‰**ï¼š
    - åœ¨ç½‘ç»œåˆ†åŒºæƒ…å†µä¸‹ï¼Œä¸¤é˜¶æ®µæäº¤åè®®å¯èƒ½ä¼šé™·å…¥é˜»å¡çŠ¶æ€ï¼Œæ— æ³•å®Œæˆäº‹åŠ¡ã€‚å› æ­¤ï¼Œéœ€è¦ç»“åˆè¶…æ—¶æœºåˆ¶æˆ–ä»²è£æœºåˆ¶æ¥å¤„ç†ã€‚ä¾‹å¦‚ï¼Œè®¾ç½®è¶…æ—¶é˜ˆå€¼ï¼Œå¦‚æœåœ¨è§„å®šæ—¶é—´å†…æœªèƒ½å®Œæˆæäº¤æˆ–å›æ»šï¼Œåˆ™è¿›è¡Œå›æ»šæ“ä½œã€‚
3. **ä¸‰é˜¶æ®µæäº¤åè®®ï¼ˆ3PCï¼‰**ï¼š
    - ä¸‰é˜¶æ®µæäº¤åè®®æ˜¯åœ¨ä¸¤é˜¶æ®µæäº¤åè®®åŸºç¡€ä¸Šçš„æ”¹è¿›ï¼Œå¢åŠ äº†ä¸€ä¸ªâ€œå‡†å¤‡æäº¤â€é˜¶æ®µï¼Œå‡å°‘äº†é˜»å¡çš„å¯èƒ½æ€§ã€‚å³ä½¿åœ¨ç½‘ç»œåˆ†åŒºæƒ…å†µä¸‹ï¼Œä¸‰é˜¶æ®µæäº¤åè®®ä¹Ÿèƒ½æ›´å¥½åœ°å¤„ç†äº‹åŠ¡çš„ä¸€è‡´æ€§é—®é¢˜ã€‚
4. **åŸºäºä»²è£çš„è§£å†³æ–¹æ¡ˆ**ï¼š
    - ä½¿ç”¨ä»²è£æœºåˆ¶æ¥å†³å®šäº‹åŠ¡çš„æœ€ç»ˆçŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œå¼•å…¥ä¸€ä¸ªä»²è£èŠ‚ç‚¹ï¼ˆæˆ–å¤šä¸ªä»²è£èŠ‚ç‚¹ï¼‰ï¼Œåœ¨ç½‘ç»œåˆ†åŒºæœŸé—´ç”±ä»²è£èŠ‚ç‚¹æ¥å†³å®šäº‹åŠ¡çš„æäº¤æˆ–å›æ»šçŠ¶æ€ã€‚
5. **åŸºäºç‰ˆæœ¬çš„è§£å†³æ–¹æ¡ˆ**ï¼š
    - ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶æœºåˆ¶æ¥å¤„ç†æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ä¹è§‚é”æˆ–å‘é‡æ—¶é’Ÿæ¥è·Ÿè¸ªæ•°æ®çš„ç‰ˆæœ¬ï¼Œåœ¨ç½‘ç»œåˆ†åŒºæ¢å¤åè¿›è¡Œå†²çªæ£€æµ‹å’Œè§£å†³ã€‚
6. **æœ€ç»ˆä¸€è‡´æ€§**ï¼š
    - åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œå…è®¸æ•°æ®åœ¨çŸ­æ—¶é—´å†…ä¸ä¸€è‡´ï¼Œä½†æœ€ç»ˆä¼šè¾¾åˆ°ä¸€è‡´çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨äº‹ä»¶æº¯æºï¼ˆEvent Sourcingï¼‰æˆ–åŸºäºæ¶ˆæ¯çš„ç³»ç»Ÿï¼Œé€šè¿‡å¼‚æ­¥æ¶ˆæ¯ä¼ é€’æ¥ç¡®ä¿æœ€ç»ˆä¸€è‡´æ€§ã€‚
7. **æ•…éšœæ£€æµ‹å’Œè‡ªåŠ¨æ¢å¤**ï¼š
    - ä½¿ç”¨æ•…éšœæ£€æµ‹æœºåˆ¶æ¥ç›‘æ§ç½‘ç»œåˆ†åŒºæƒ…å†µï¼Œå¹¶åœ¨æ£€æµ‹åˆ°ç½‘ç»œåˆ†åŒºæ—¶é‡‡å–ç›¸åº”çš„æ¢å¤æªæ–½ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨å¿ƒè·³æ£€æµ‹ï¼ˆHeartbeatï¼‰å’Œè¶…æ—¶æœºåˆ¶æ¥æ£€æµ‹å’Œæ¢å¤ç½‘ç»œåˆ†åŒºã€‚

### å®ä¾‹
#### ä¸¤é˜¶æ®µæäº¤åè®®å’Œè¶…æ—¶æœºåˆ¶
åœ¨ä½¿ç”¨ä¸¤é˜¶æ®µæäº¤åè®®æ—¶ï¼Œå¯ä»¥ç»“åˆè¶…æ—¶æœºåˆ¶æ¥å¤„ç†ç½‘ç»œåˆ†åŒºé—®é¢˜ï¼š

```plain
public class TransactionManager {
    private static final int TIMEOUT = 3000; // è¶…æ—¶é˜ˆå€¼ï¼Œå•ä½ï¼šæ¯«ç§’

    public void commitTransaction(Transaction transaction) {
        long startTime = System.currentTimeMillis();
        try {
            // é˜¶æ®µä¸€ï¼šå‡†å¤‡æäº¤
            for (ResourceManager rm : transaction.getResourceManagers()) {
                rm.prepare(transaction);
            }

            // æ£€æŸ¥è¶…æ—¶
            if (System.currentTimeMillis() - startTime > TIMEOUT) {
                rollbackTransaction(transaction);
                return;
            }

            // é˜¶æ®µäºŒï¼šæäº¤
            for (ResourceManager rm : transaction.getResourceManagers()) {
                rm.commit(transaction);
            }
        } catch (Exception e) {
            rollbackTransaction(transaction);
        }
    }

    public void rollbackTransaction(Transaction transaction) {
        for (ResourceManager rm : transaction.getResourceManagers()) {
            try {
                rm.rollback(transaction);
            } catch (Exception e) {
                // å¤„ç†å›æ»šå¤±è´¥
            }
        }
    }
}
```

#### åŸºäºä»²è£çš„è§£å†³æ–¹æ¡ˆ
å¼•å…¥ä¸€ä¸ªä»²è£èŠ‚ç‚¹ï¼Œåœ¨ç½‘ç»œåˆ†åŒºæœŸé—´ç”±ä»²è£èŠ‚ç‚¹å†³å®šäº‹åŠ¡çš„æœ€ç»ˆçŠ¶æ€ï¼š

```plain
public class Arbiter {
    private Map<String, TransactionStatus> transactionStatusMap = new ConcurrentHashMap<>();

    public void decideTransaction(String transactionId, TransactionStatus status) {
        transactionStatusMap.put(transactionId, status);
    }

    public TransactionStatus getTransactionStatus(String transactionId) {
        return transactionStatusMap.get(transactionId);
    }
}

public class TransactionManager {
    private Arbiter arbiter = new Arbiter();

    public void commitTransaction(Transaction transaction) {
        // é˜¶æ®µä¸€ï¼šå‡†å¤‡æäº¤
        for (ResourceManager rm : transaction.getResourceManagers()) {
            rm.prepare(transaction);
        }

        // ç”±ä»²è£èŠ‚ç‚¹å†³å®šäº‹åŠ¡çŠ¶æ€
        TransactionStatus status = arbiter.getTransactionStatus(transaction.getId());
        if (status == TransactionStatus.COMMIT) {
            // é˜¶æ®µäºŒï¼šæäº¤
            for (ResourceManager rm : transaction.getResourceManagers()) {
                rm.commit(transaction);
            }
        } else {
            rollbackTransaction(transaction);
        }
    }

    public void rollbackTransaction(Transaction transaction) {
        for (ResourceManager rm : transaction.getResourceManagers()) {
            try {
                rm.rollback(transaction);
            } catch (Exception e) {
                // å¤„ç†å›æ»šå¤±è´¥
            }
        }
    }
}
```



> åŸæ–‡: <https://www.yuque.com/jingdianjichi/xyxdsi/bbc0ylhfydoszrep>
# ðŸ‘Œè¯¦ç»†è¯´ä¸€ä¸‹ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰åè®®æ˜¯ä»€ä¹ˆï¼Ÿ

ä¸¤é˜¶æ®µæäº¤åè®®ï¼ˆ2PCï¼ŒTwo-Phase Commitï¼‰æ˜¯ä¸€ç§ç»å…¸çš„åˆ†å¸ƒå¼äº‹åŠ¡åè®®ï¼Œç”¨äºŽç¡®ä¿åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å¤šä¸ªèŠ‚ç‚¹ï¼ˆæˆ–å‚ä¸Žè€…ï¼‰åœ¨å¤„ç†åŒä¸€ä¸ªäº‹åŠ¡æ—¶èƒ½å¤Ÿä¿æŒä¸€è‡´æ€§ã€‚2PCåè®®é€šè¿‡å°†äº‹åŠ¡çš„æäº¤è¿‡ç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µæ¥å®žçŽ°è¿™ä¸€ç›®æ ‡ï¼šå‡†å¤‡é˜¶æ®µå’Œæäº¤é˜¶æ®µã€‚

### 1. å‡†å¤‡é˜¶æ®µï¼ˆPrepare Phaseï¼‰
åœ¨å‡†å¤‡é˜¶æ®µï¼Œäº‹åŠ¡åè°ƒè€…ï¼ˆCoordinatorï¼‰ä¼šå‘æ‰€æœ‰å‚ä¸Žè€…ï¼ˆParticipantsï¼‰å‘é€å‡†å¤‡è¯·æ±‚ï¼Œè¯¢é—®ä»–ä»¬æ˜¯å¦å¯ä»¥å‡†å¤‡æäº¤äº‹åŠ¡ã€‚æ¯ä¸ªå‚ä¸Žè€…åœ¨æ”¶åˆ°å‡†å¤‡è¯·æ±‚åŽï¼Œä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

+ **æ‰§è¡Œäº‹åŠ¡æ“ä½œ**ï¼šå‚ä¸Žè€…å°è¯•æ‰§è¡Œäº‹åŠ¡ï¼Œä½†ä¸æäº¤ï¼ˆå³ä¿æŒäº‹åŠ¡å¤„äºŽæœªæäº¤çŠ¶æ€ï¼‰ã€‚
+ **è®°å½•æ—¥å¿—**ï¼šå‚ä¸Žè€…å°†äº‹åŠ¡æ“ä½œçš„çŠ¶æ€ï¼ˆå‡†å¤‡æˆåŠŸæˆ–å¤±è´¥ï¼‰è®°å½•åˆ°æŒä¹…åŒ–å­˜å‚¨ï¼ˆå¦‚æ—¥å¿—æ–‡ä»¶æˆ–æ•°æ®åº“ï¼‰ä¸­ï¼Œä»¥ä¾¿åœ¨ç³»ç»Ÿæ•…éšœåŽèƒ½å¤Ÿæ¢å¤ã€‚
+ **å‘é€å“åº”**ï¼šå‚ä¸Žè€…å°†æ‰§è¡Œç»“æžœï¼ˆå‡†å¤‡æˆåŠŸæˆ–å¤±è´¥ï¼‰è¿”å›žç»™åè°ƒè€…ã€‚

### 2. æäº¤é˜¶æ®µï¼ˆCommit Phaseï¼‰
åœ¨æäº¤é˜¶æ®µï¼Œåè°ƒè€…æ ¹æ®æ‰€æœ‰å‚ä¸Žè€…çš„å“åº”å†³å®šäº‹åŠ¡çš„æœ€ç»ˆç»“æžœã€‚å¦‚æžœæ‰€æœ‰å‚ä¸Žè€…éƒ½å‡†å¤‡æˆåŠŸï¼Œåè°ƒè€…ä¼šå‘é€æäº¤è¯·æ±‚ï¼›å¦‚æžœæœ‰ä»»ä½•å‚ä¸Žè€…å‡†å¤‡å¤±è´¥ï¼Œåè°ƒè€…ä¼šå‘é€å›žæ»šè¯·æ±‚ã€‚å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š

+ **æäº¤äº‹åŠ¡**ï¼šå¦‚æžœæ‰€æœ‰å‚ä¸Žè€…éƒ½å‡†å¤‡æˆåŠŸï¼Œåè°ƒè€…å‘æ‰€æœ‰å‚ä¸Žè€…å‘é€æäº¤è¯·æ±‚ã€‚å‚ä¸Žè€…åœ¨æ”¶åˆ°æäº¤è¯·æ±‚åŽï¼Œæäº¤äº‹åŠ¡å¹¶é‡Šæ”¾èµ„æºã€‚
+ **å›žæ»šäº‹åŠ¡**ï¼šå¦‚æžœæœ‰ä»»ä½•å‚ä¸Žè€…å‡†å¤‡å¤±è´¥ï¼Œåè°ƒè€…å‘æ‰€æœ‰å‚ä¸Žè€…å‘é€å›žæ»šè¯·æ±‚ã€‚å‚ä¸Žè€…åœ¨æ”¶åˆ°å›žæ»šè¯·æ±‚åŽï¼Œå›žæ»šäº‹åŠ¡å¹¶é‡Šæ”¾èµ„æºã€‚

### è¯¦ç»†æµç¨‹å›¾
```plain
Coordinator                  Participant 1                  Participant 2
     |                            |                             |
     |------ Prepare Request ---->|                             |
     |                            |                             |
     |<------ Prepare OK ---------|                             |
     |                            |                             |
     |                            |------ Prepare Request ----->|
     |                            |                             |
     |                            |<------ Prepare OK ----------|
     |                            |                             |
     |------ Commit Request ----->|                             |
     |                            |                             |
     |                            |------ Commit Request ------>|
     |                            |                             |
     |                            |                             |
```

### 2PCçš„ä¼˜ç‚¹å’Œç¼ºç‚¹
**ä¼˜ç‚¹ï¼š**

+ **ç®€å•æ˜“å®žçŽ°**ï¼š2PCåè®®çš„æµç¨‹ç›¸å¯¹ç®€å•ï¼Œæ˜“äºŽç†è§£å’Œå®žçŽ°ã€‚
+ **æ•°æ®ä¸€è‡´æ€§**ï¼šåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œ2PCèƒ½å¤Ÿä¿è¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ•°æ®ä¸€è‡´æ€§ã€‚

**ç¼ºç‚¹ï¼š**

+ **å•ç‚¹æ•…éšœ**ï¼šåè°ƒè€…æ˜¯å•ç‚¹æ•…éšœï¼Œå¦‚æžœåè°ƒè€…åœ¨å‡†å¤‡é˜¶æ®µå’Œæäº¤é˜¶æ®µä¹‹é—´æ•…éšœï¼Œç³»ç»Ÿå¯èƒ½ä¼šè¿›å…¥ä¸ç¡®å®šçŠ¶æ€ã€‚
+ **é˜»å¡žé—®é¢˜**ï¼šå¦‚æžœå‚ä¸Žè€…åœ¨å‡†å¤‡é˜¶æ®µé”å®šèµ„æºï¼Œç›´åˆ°æ”¶åˆ°æäº¤æˆ–å›žæ»šè¯·æ±‚ä¸ºæ­¢ï¼Œå¯èƒ½ä¼šå¯¼è‡´èµ„æºé•¿æ—¶é—´è¢«é”å®šï¼Œä»Žè€Œå½±å“ç³»ç»Ÿæ€§èƒ½ã€‚
+ **ç½‘ç»œåˆ†åŒºé—®é¢˜**ï¼šåœ¨ç½‘ç»œåˆ†åŒºçš„æƒ…å†µä¸‹ï¼Œåè°ƒè€…å’Œå‚ä¸Žè€…ä¹‹é—´çš„é€šä¿¡å¯èƒ½ä¼šå¤±è´¥ï¼Œå¯¼è‡´äº‹åŠ¡æ— æ³•å®Œæˆã€‚

### 2PCçš„æ”¹è¿›
ç”±äºŽ2PCå­˜åœ¨ä¸€äº›å›ºæœ‰çš„ç¼ºç‚¹ï¼Œå®žé™…åº”ç”¨ä¸­å¸¸å¸¸ä¼šå¯¹å…¶è¿›è¡Œæ”¹è¿›æˆ–é‡‡ç”¨å…¶ä»–åè®®æ¥æé«˜å¯é æ€§å’Œæ€§èƒ½ã€‚ä¾‹å¦‚ï¼š

+ **ä¸‰é˜¶æ®µæäº¤åè®®ï¼ˆ3PCï¼‰**ï¼šåœ¨2PCçš„åŸºç¡€ä¸Šå¢žåŠ ä¸€ä¸ªé¢„æäº¤é˜¶æ®µï¼Œä»¥å‡å°‘é˜»å¡žæ—¶é—´å’Œå•ç‚¹æ•…éšœçš„å½±å“ã€‚
+ **åŸºäºŽæ¶ˆæ¯é˜Ÿåˆ—çš„æœ€ç»ˆä¸€è‡´æ€§**ï¼šé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å’Œè¡¥å¿æœºåˆ¶å®žçŽ°æœ€ç»ˆä¸€è‡´æ€§ï¼Œé¿å…é•¿æ—¶é—´é”å®šèµ„æºã€‚
+ **TCCæ¨¡å¼**ï¼šå°†äº‹åŠ¡æ“ä½œåˆ†ä¸ºå°è¯•ï¼ˆTryï¼‰ã€ç¡®è®¤ï¼ˆConfirmï¼‰å’Œå–æ¶ˆï¼ˆCancelï¼‰ä¸‰ä¸ªæ­¥éª¤ï¼Œæä¾›æ›´çµæ´»çš„äº‹åŠ¡ç®¡ç†ã€‚



> åŽŸæ–‡: <https://www.yuque.com/jingdianjichi/xyxdsi/fqi90gal1iivsgs7>
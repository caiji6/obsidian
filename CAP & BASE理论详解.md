---
title: CAP & BASE理论详解
categories:
  - 分布式
tags:
  - 分布式理论
halo:
  site: http://120.76.228.140:8090
  name: 4fa231ba-6fbb-472a-8cd5-0562e4bcbfae
  publish: true
---

## CAP理论

---

CAP 理论/定理起源于 2000 年，由加州大学伯克利分校的 Eric Brewer 教授在分布式计算原理研讨会（PODC）上提出，因此 CAP 定理又被称作 **布鲁尔定理（Brewer’s theorem）**

2 年后，麻省理工学院的 Seth Gilbert 和 Nancy Lynch 发表了布鲁尔猜想的证明，CAP 理论正式成为分布式领域的定理。

### CAP理论的核心思想
![2024-03-09T22:51:03-jdqllacg.webp](https://crj-b.oss-cn-shenzhen.aliyuncs.com/2024/03/09/2024-03-09T22:51:03-jdqllacg.webp)

> **当发生网络分区的时候，如果我们要继续服务，那么强一致性和可用性只能 2 选 1。也就是说当网络分区之后 P 是前提，决定了 P 之后才有 C 和 A 的选择。也就是说分区容错性我们是必须要实现的**。
> 简而言之就是：CAP理论中分区容错性P是一定要满足的，在此基础上，只能满足可用性A或者一致性C。
> 

### CAP理论三要素

- **分区容错性（Partition Tolerance）**

>  the system continues to operate despite arbitrary message loss or failure of part of part of the system

![2024-03-09T22:51:03-fqffmqac.png](https://crj-b.oss-cn-shenzhen.aliyuncs.com/2024/03/09/2024-03-09T22:51:03-fqffmqac.png)


分布式系统出现**网络分区**的时候，仍然能过对外提供服务

分布式系统中，多个节点之间的网络本来是连通的，但是因为某些故障（比如部分节点网络出了问题）某些节点之间不连通了，整个网络就分成了几块区域，这就叫 **网络分区**。

- **一致性（Consistency）**

> all nodes see the same data at the same time

![2024-03-09T22:51:03-xaopywxz.png](https://crj-b.oss-cn-shenzhen.aliyuncs.com/2024/03/09/2024-03-09T22:51:03-xaopywxz.png)


所有节点访问同一份最新的数据副本

1、由于存在数据同步的过程，写操作的响应会有一定的延迟。

2、为了保证数据一致性会对资源暂时锁定，待数据同步完成释放锁定资源，此时有请求对该数据的操作会阻塞。

- **可用性（Availability）**

> reads and writes always succeed

![2024-03-09T22:51:03-hlvwyuhu.png](https://crj-b.oss-cn-shenzhen.aliyuncs.com/2024/03/09/2024-03-09T22:51:03-hlvwyuhu.png)


非故障的节点在合理的时间内返回合理的响应（不是错误或者超时的响应）。

### 为啥不可能选择CA架构呢？

若系统出现网络分区，系统中的某个节点在进行写操作。为了保证C，必须要禁止其他节点的读写操作，这就和A发生冲突了。如果为了保证A，其他节点的读写操作正常的话，那就和C发生冲突了。

如果系统没有发生网络分区的情况，也就是说P不存在的时候，就可以保证CA，但是只要是分布式系统就肯定存在节点之间的网络通信，就有可能发生网络分区。

### 为什么必须保证P？

因为分布式系统与单机不同，它涉及到了多节点间的通信和数据交互，避免不了网络问题，如果没有分区容错性，就意味着系统不允许出现节点间的通信出现任何错误，错误就意味着系统不可用，这在绝大数系统中无法接受的。因此对节点间的分区故障容错是必须要考虑的，也是 CAP 定理中分区容错性通常首先要保证的原因。

### CAP实际应用案例

1. **ZooKeeper保证的是CP。**
2. **Eureka保证的则是AP。**
3. **Nacos不仅支持CP也支持AP。**

## BASE理论

---

BASE理论起源于2008年，有eBay的架构师Dan Pritchett在ACM上发表。

BASE 理论是对 CAP 中一致性 C 和可用性 A 权衡的结果，其来源于对大规模互联网系统分布式实践的总结，是基于 CAP 定理逐步演化而来的，它大大降低了我们对系统的要求。

![2024-03-09T22:51:03-pdxralob.png](https://crj-b.oss-cn-shenzhen.aliyuncs.com/2024/03/09/2024-03-09T22:51:03-pdxralob.png)


### BASE理论的核心思想

**即使无法做到强一致性，但每个应用都可以根据自身业务特点，采用适当的方式来使系统达到最终一致性。也就是牺牲数据的一致性来满足系统的高可用性。**

BASE理论本质上是对CAP理论的延伸和补充，更具体地说，是对CAP中AP方案的一个补充。

### BASE理论三要素

- **基本可用（Basically Available）**

基本可用是指分布式系统在出现可不预知故障的时候，**允许损失部分可用性**。但是，这绝不等价于系统不可用。

**什么叫允许损失部分可用性呢？**

**响应时间上的损失**：正常情况下，处理用户请求需要0.5 s返回结果，但是由于系统出现故障，处理用户请求的时间变为3 s。

**系统功能上的损失**：正常情况下，用户可以使用系统的全部功能，但是由于系统访问量突然剧增，系统的部分非核心功能无法使用。

- **软状态（Soft-state）**

软状态指允许系统中的数据存在中间状态（**CAP 理论中的数据不一致**），并认为该中间状态的存在不会影响系统的整体可用性，即允许系统在不同节点的数据副本之间进行数据同步的过程存在延时。

- **最终一致性（Eventually Consistent）**

最终一致性强调的是系统中所有的数据副本，在经过一段时间的同步后，最终能够达到一个一致的状态。因此，最终一致性的本质是需要系统保证最终数据能够达到一致，而不需要实时保证系统数据的强一致性。

> 分布式一致性的3种级别：
> 1.**强一致性**：系统写入了什么，读出来的就是什么。
> 2.**弱一致性**：不一定可以读取到最新写入的值，也不保证多少时间之后读取到的数据是最新的，只是会尽量保证某个时刻达到数据一致的状态。
> 3.**最终一致性**：弱一致性的升级版，系统会保证在一定时间内达到数据一致的状态。
> 

 实现最终一致性的具体方式
▪️**读时修复**：在读取数据时，检测数据的不一致，进行修复。
▪️**写时修复**：在写入数据，检测数据的不一致时，进行修复。
▪️**异步修复**：这个是最常用的方式，通过定时对账检测副本数据的一致性，并修复。
